<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Claude Chat</title>
    <!-- ÂºïÂÖ• React Âíå ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- ÂºïÂÖ• Babel Standalone Áî®‰∫é JSX ËΩ¨Êç¢ -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 16px;
            background: #252526;
            border-bottom: 1px solid #3e3e42;
            flex-shrink: 0;
        }

        .header-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-button {
            padding: 4px 12px;
            background: #5a5a5a;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        .header-button:hover {
            background: #6a6a6a;
        }

        .new-chat-btn {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid #555;
            border-radius: 4px;
            color: #cccccc;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: all 0.15s ease;
        }

        .new-chat-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #777;
        }

        .header .status {
            font-size: 12px;
            color: #858585;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Ê∂àÊÅØÊ†∑Âºè */
        .message {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            max-width: 85%;
        }

        .message.user {
            background: #2d5a8c;
            margin-left: auto;
        }

        .message.assistant {
            background: #2d2d2d;
        }

        .message.error {
            background: #5a1d1d;
            color: #f48771;
        }

        .message-role {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .message-content {
            line-height: 1.6;
        }

        /* ÊñáÊú¨Âùó */
        .text-block {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* ÊÄùËÄÉËøáÁ®ãÂùó - ÁÆÄÊ¥ÅÊ†∑Âºè */
        /* ThinkingÂùóÊ†∑Âºè */
        .thinking-block {
            margin: 8px 0;
        }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            padding: 6px 8px;
            border-radius: 4px;
            transition: background-color 0.15s ease;
        }

        .thinking-header:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .thinking-header:hover .thinking-title,
        .thinking-header:hover .thinking-toggle {
            opacity: 1;
        }

        .thinking-title {
            font-size: 13px;
            font-style: italic;
            color: #888;
            opacity: 0.8;
            transition: opacity 0.15s ease;
            flex: 1;
        }

        .thinking-toggle {
            font-size: 11px;
            color: #888;
            opacity: 0.6;
            transition: opacity 0.15s ease;
        }

        .thinking-content {
            margin-top: 6px;
            margin-left: 24px;
            padding: 10px 12px;
            background-color: rgba(255, 255, 255, 0.02);
            border-left: 2px solid rgba(136, 136, 136, 0.3);
            border-radius: 0 4px 4px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 12.5px;
            color: #999;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .thinking-content.collapsed {
            display: none;
        }

        /* Â∑•ÂÖ∑‰ΩøÁî®Âùó - Êó∂Èó¥Á∫øÈ£éÊ†º */
        .tool-block {
            margin: 8px 0;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .tool-block:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .tool-main-line {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-icon {
            font-size: 16px;
            color: #64b5f6;
            flex-shrink: 0;
        }

        .tool-label {
            font-weight: 500;
            color: #eee;
            font-size: 14px;
        }

        .tool-file-link {
            color: #4caf50;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
            font-weight: 500;
        }

        .tool-file-link:hover {
            color: #66bb6a;
            text-decoration: underline;
        }

        .tool-params {
            margin-top: 6px;
            margin-left: 24px;
            font-size: 13px;
            color: #aaa;
        }

        .tool-param-line {
            margin: 2px 0;
        }

        .param-key {
            color: #999;
            font-size: 12px;
        }

        .param-value {
            color: #ccc;
            margin-left: 4px;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading {
            display: none;
            padding: 12px;
            text-align: center;
            color: #858585;
        }

        .loading.show {
            display: block;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* ËæìÂÖ•Âå∫Âüü */
        .input-area {
            padding: 16px;
            background: #252526;
            border-top: 1px solid #3e3e42;
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: 8px;
        }

        #messageInput {
            flex: 1;
            padding: 10px 12px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #cccccc;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        #messageInput:focus {
            outline: none;
            border-color: #4a90e2;
        }

        #sendButton {
            padding: 10px 20px;
            background: #4a90e2;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }

        #sendButton:hover {
            background: #5a9ee8;
        }

        #sendButton:active {
            background: #3a80d2;
        }

        #sendButton:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [status, setStatus] = useState('Â∞±Áª™');
            const [loading, setLoading] = useState(false);
            const [expandedThinking, setExpandedThinking] = useState({});
            const messagesContainerRef = useRef(null);
            const inputRef = useRef(null);

            useEffect(() => {
                console.log('React app mounted');

                // ÂÖ®Â±ÄÊö¥Èú≤ÊñπÊ≥ï‰æõ Java Ë∞ÉÁî®
                window.updateMessages = updateMessages;
                window.updateStatus = updateStatus;
                window.showLoading = showLoading;
            }, []);

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            useEffect(() => {
                // Ëá™Âä®Ë∞ÉÊï¥ textarea È´òÂ∫¶
                if (inputRef.current) {
                    inputRef.current.style.height = 'auto';
                    inputRef.current.style.height = inputRef.current.scrollHeight + 'px';
                }
            }, [inputMessage]);

            const scrollToBottom = () => {
                if (messagesContainerRef.current) {
                    messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
                }
            };

            const sendMessage = () => {
                const message = inputMessage.trim();
                if (!message || loading) return;

                // ÈÄöËøáÊ°•Êé•ÂèëÈÄÅÂà∞ Java
                window.sendToJava('send_message:' + message);

                // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                setInputMessage('');
            };

            const interruptSession = () => {
                window.sendToJava('interrupt_session:');
                updateStatus('Â∑≤ÂèëÈÄÅ‰∏≠Êñ≠ËØ∑Ê±Ç');
            };

            const restartSession = () => {
                if (confirm('Á°ÆÂÆöË¶ÅÈáçÂêØ‰ºöËØùÂêóÔºüËøôÂ∞ÜÊ∏ÖÁ©∫ÂΩìÂâçÂØπËØùÂéÜÂè≤„ÄÇ')) {
                    window.sendToJava('restart_session:');
                    setMessages([]);
                    updateStatus('Ê≠£Âú®ÈáçÂêØ‰ºöËØù...');
                }
            };

            const createNewSession = () => {
                // Ê£ÄÊü•ÂΩìÂâç‰ºöËØùÊòØÂê¶‰∏∫Á©∫
                if (messages.length === 0) {
                    // ÂΩìÂâç‰ºöËØù‰∏∫Á©∫ÔºåÁõ¥Êé•Â§çÁî®
                    updateStatus('ÂΩìÂâç‰ºöËØù‰∏∫Á©∫ÔºåÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®');
                    return;
                }

                // ÂΩìÂâç‰ºöËØù‰∏ç‰∏∫Á©∫ÔºåÂàõÂª∫Êñ∞‰ºöËØù
                if (confirm('ÂΩìÂâç‰ºöËØùÂ∑≤ÊúâÊ∂àÊÅØÔºåÁ°ÆÂÆöË¶ÅÂàõÂª∫Êñ∞‰ºöËØùÂêóÔºü')) {
                    window.sendToJava('create_new_session:');
                    setMessages([]);
                    updateStatus('Ê≠£Âú®ÂàõÂª∫Êñ∞‰ºöËØù...');
                }
            };

            // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®Ôºà‰ªé Java Ë∞ÉÁî®Ôºâ
            const updateMessages = (messagesJson) => {
                console.log('[updateMessages] Received JSON:', messagesJson);
                try {
                    const parsed = JSON.parse(messagesJson);
                    console.log('[updateMessages] Parsed messages:', parsed);
                    setMessages(parsed);
                } catch (e) {
                    console.error('[updateMessages] Failed to parse messages:', e);
                    console.error('[updateMessages] JSON string:', messagesJson);
                }
            };

            // Êõ¥Êñ∞Áä∂ÊÄÅÔºà‰ªé Java Ë∞ÉÁî®Ôºâ
            const updateStatus = (text) => {
                setStatus(text);
            };

            // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅÔºà‰ªé Java Ë∞ÉÁî®Ôºâ
            const showLoading = (show) => {
                setLoading(show === 'true' || show === true);
            };

            const getRoleName = (type) => {
                const roleNames = {
                    'user': 'You',
                    'assistant': 'Assistant',
                    'error': 'Error'
                };
                return roleNames[type] || type;
            };

            // Âà§Êñ≠ÊòØÂê¶Â∫îËØ•ÊòæÁ§∫Ê∂àÊÅØ
            const shouldShowMessage = (msg) => {
                if (msg.type === 'assistant') {
                    return true;
                }

                if (msg.type === 'user' || msg.type === 'error') {
                    const text = getMessageText(msg);
                    if (!text || text.trim() === '' || text === '(Á©∫Ê∂àÊÅØ)') {
                        return false;
                    }
                }

                return true;
            };

            // Ëé∑ÂèñÊ∂àÊÅØÊñáÊú¨ÂÜÖÂÆπÔºàÁî®‰∫é user Âíå error Ê∂àÊÅØÔºâ
            const getMessageText = (msg) => {
                if (msg.content) {
                    return msg.content;
                }

                if (msg.raw) {
                    if (typeof msg.raw === 'string') {
                        return msg.raw;
                    }

                    if (msg.raw.content && typeof msg.raw.content === 'string') {
                        return msg.raw.content;
                    }

                    if (Array.isArray(msg.raw.content)) {
                        return msg.raw.content
                            .filter(block => block && block.type === 'text')
                            .map(block => block.text || '')
                            .join('\n');
                    }
                }

                return '(Á©∫Ê∂àÊÅØ)';
            };

            const getContentBlocks = (msg) => {
                console.log('[getContentBlocks] Processing message:', msg);
                console.log('[getContentBlocks] msg.raw:', msg.raw);

                if (msg.raw) {
                    const raw = msg.raw;

                    if (typeof raw === 'string') {
                        return [{ type: 'text', text: raw }];
                    }

                    // JSONLÊ†ºÂºèÔºöraw.message.content
                    let content = null;
                    if (raw.message && raw.message.content) {
                        console.log('[getContentBlocks] Found raw.message.content');
                        content = raw.message.content;
                    }
                    // ÂÖºÂÆπÊóßÊ†ºÂºèÔºöraw.content
                    else if (raw.content) {
                        console.log('[getContentBlocks] Found raw.content');
                        content = raw.content;
                    }

                    if (content) {
                        if (typeof content === 'string') {
                            return [{ type: 'text', text: content }];
                        }

                        if (Array.isArray(content)) {
                            const blocks = content.map(block => {
                                if (!block || !block.type) return null;

                                if (block.type === 'text') {
                                    return { type: 'text', text: block.text || '' };
                                } else if (block.type === 'thinking') {
                                    const thinkingContent = block.thinking || block.text || '';
                                    console.log('[getContentBlocks] ‚úÖ Found thinking block! Length:', thinkingContent.length, 'Preview:', thinkingContent.substring(0, 100));
                                    return {
                                        type: 'thinking',
                                        thinking: thinkingContent,
                                        text: thinkingContent
                                    };
                                } else if (block.type === 'tool_use') {
                                    return {
                                        type: 'tool_use',
                                        name: block.name || 'Unknown',
                                        input: block.input || {}
                                    };
                                }
                                return null;
                            }).filter(Boolean);

                            console.log('[getContentBlocks] Final parsed blocks:', blocks);
                            return blocks.length > 0 ? blocks : [{ type: 'text', text: '(Êó†Ê≥ïËß£ÊûêÂÜÖÂÆπ)' }];
                        }
                    }
                }

                if (msg.content) {
                    console.log('[getContentBlocks] Using msg.content:', msg.content);
                    return [{ type: 'text', text: msg.content }];
                }

                console.warn('[getContentBlocks] No content found for message:', msg);
                return [{ type: 'text', text: '(Á©∫Ê∂àÊÅØ)' }];
            };

            const getToolIcon = (toolName) => {
                const icons = {
                    'Read': 'üëÅÔ∏è',
                    'Edit': '‚úèÔ∏è',
                    'Write': 'üìù',
                    'Bash': '‚ö°',
                    'Grep': 'üîç',
                    'Glob': 'üìÅ',
                    'Task': 'üîß',
                    'WebFetch': 'üåê',
                    'WebSearch': 'üîé'
                };
                return icons[toolName] || 'üõ†Ô∏è';
            };

            const getToolDisplayName = (toolName) => {
                const toolNames = {
                    'Read': 'ËØªÂèñ',
                    'Edit': 'ÁºñËæë',
                    'Write': 'ÂÜôÂÖ•',
                    'Bash': 'ÊâßË°åÂëΩ‰ª§',
                    'Grep': 'ÊêúÁ¥¢',
                    'Glob': 'Êü•ÊâæÊñá‰ª∂',
                    'Task': 'ÊâßË°å‰ªªÂä°',
                    'WebFetch': 'Ëé∑ÂèñÁΩëÈ°µ',
                    'WebSearch': 'ÁΩëÁªúÊêúÁ¥¢'
                };
                return toolNames[toolName] || toolName;
            };

            const getFilePath = (toolInput) => {
                if (!toolInput) return null;
                return toolInput.file_path || toolInput.notebook_path || null;
            };

            const getFileName = (filePath) => {
                if (!filePath) return '';
                const parts = filePath.split('/');
                return parts[parts.length - 1];
            };

            const hasOtherParams = (toolInput) => {
                if (!toolInput) return false;
                const otherParams = getOtherParams(toolInput);
                return Object.keys(otherParams).length > 0;
            };

            const getOtherParams = (toolInput) => {
                if (!toolInput) return {};
                const params = { ...toolInput };
                delete params.file_path;
                delete params.notebook_path;
                return params;
            };

            const formatParamValue = (value) => {
                if (typeof value === 'object') {
                    return JSON.stringify(value, null, 2);
                }
                return String(value);
            };

            const openFile = (filePath) => {
                console.log('Opening file:', filePath);
                if (window.sendToJava) {
                    window.sendToJava('open_file:' + filePath);
                }
            };

            const toggleThinking = (messageIndex, blockIndex) => {
                const key = `${messageIndex}_${blockIndex}`;
                setExpandedThinking(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            const isThinkingExpanded = (messageIndex, blockIndex) => {
                const key = `${messageIndex}_${blockIndex}`;
                return !!expandedThinking[key];
            };

            const handleKeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            return (
                <>
                    <div className="header">
                        <div className="header-title">
                            <h1>Claude Code GUI</h1>
                            <div className="header-actions">
                                <button className="new-chat-btn" onClick={createNewSession} title="Êñ∞Âª∫‰ºöËØù">+</button>
                                <button className="header-button" onClick={interruptSession}>‚è∏ ‰∏≠Êñ≠</button>
                                {/* <button className="header-button" onClick={restartSession}>üîÑ ÈáçÂêØ</button> */}
                            </div>
                        </div>
                        <div className="status">{status}</div>
                    </div>

                    <div className="messages-container" ref={messagesContainerRef}>
                        {messages.map((msg, index) => {
                            if (!shouldShowMessage(msg)) return null;

                            return (
                                <div key={index} className={`message ${msg.type}`}>
                                    <div className="message-role">{getRoleName(msg.type)}</div>
                                    <div className="message-content">
                                        {(msg.type === 'user' || msg.type === 'error') ? (
                                            <div className="text-block">{getMessageText(msg)}</div>
                                        ) : (
                                            getContentBlocks(msg).map((block, blockIndex) => (
                                                <div key={blockIndex} className="content-block">
                                                    {block.type === 'text' && (
                                                        <div className="text-block">{block.text}</div>
                                                    )}

                                                    {block.type === 'thinking' && (
                                                        <div className="thinking-block">
                                                            <div className="thinking-header" onClick={() => toggleThinking(index, blockIndex)}>
                                                                <span className="thinking-title">üí≠ ÊÄùËÄÉËøáÁ®ã</span>
                                                                <span className="thinking-toggle">
                                                                    {isThinkingExpanded(index, blockIndex) ? '‚ñº' : '‚ñ∂'}
                                                                </span>
                                                            </div>
                                                            {isThinkingExpanded(index, blockIndex) && (
                                                                <div className="thinking-content">
                                                                    {block.thinking || block.text || '(Êó†ÊÄùËÄÉÂÜÖÂÆπ)'}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}

                                                    {block.type === 'tool_use' && (
                                                        <div className="tool-block">
                                                            <div className="tool-main-line">
                                                                <span className="tool-icon">{getToolIcon(block.name)}</span>
                                                                <span className="tool-label">{getToolDisplayName(block.name)}</span>
                                                                {getFilePath(block.input) && (
                                                                    <a
                                                                        className="tool-file-link"
                                                                        onClick={(e) => { e.preventDefault(); openFile(getFilePath(block.input)); }}
                                                                        title={getFilePath(block.input)}
                                                                    >
                                                                        {getFileName(getFilePath(block.input))}
                                                                    </a>
                                                                )}
                                                            </div>
                                                            {hasOtherParams(block.input) && (
                                                                <div className="tool-params">
                                                                    {Object.entries(getOtherParams(block.input)).map(([key, value]) => (
                                                                        <div key={key} className="tool-param-line">
                                                                            <span className="param-key">{key}:</span>
                                                                            <span className="param-value">{formatParamValue(value)}</span>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            );
                        })}

                        {loading && <div className="loading show">Claude Ê≠£Âú®ÊÄùËÄÉ</div>}
                    </div>

                    <div className="input-area">
                        <div className="input-container">
                            <textarea
                                id="messageInput"
                                ref={inputRef}
                                value={inputMessage}
                                onChange={(e) => setInputMessage(e.target.value)}
                                onKeyDown={handleKeydown}
                                placeholder="ËæìÂÖ•Ê∂àÊÅØ... (Shift+Enter Êç¢Ë°å, Enter ÂèëÈÄÅ)"
                                rows="1"
                            />
                            <button
                                id="sendButton"
                                onClick={sendMessage}
                                disabled={loading || !inputMessage.trim()}
                            >
                                ÂèëÈÄÅ
                            </button>
                        </div>
                    </div>
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
