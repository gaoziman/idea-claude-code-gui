<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude ‰ºöËØùËØ¶ÊÉÖ</title>
    <!-- ÂºïÂÖ• React Âíå ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- ÂºïÂÖ• Babel Standalone Áî®‰∫é JSX ËΩ¨Êç¢ -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC',
                       'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        #app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .session-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            opacity: 0.9;
            flex-wrap: wrap;
        }

        .back-button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Êó∂Èó¥Á∫øÊ†∑Âºè */
        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            animation: slideIn 0.3s ease;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid #1a1a2e;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .timeline-item.user::before {
            background: #4caf50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .message-card {
            background: #16213e;
            border: 1px solid #2a2a4e;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s;
        }

        .message-card:hover {
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2a2a4e;
        }

        .message-role {
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.6;
        }

        .message-body {
            line-height: 1.6;
        }

        /* ÂÜÖÂÆπÂùóÊ†∑Âºè */
        .content-block {
            margin-bottom: 12px;
        }

        .content-block:last-child {
            margin-bottom: 0;
        }

        /* ÊñáÊú¨Âùó */
        .text-block {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* ÊÄùËÄÉËøáÁ®ãÂùó - ÁÆÄÊ¥ÅÊ†∑Âºè */
        .thinking-block {
            margin: 8px 0;
        }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            padding: 4px 0;
        }

        .thinking-header:hover .thinking-title {
            opacity: 1;
        }

        .thinking-title {
            font-size: 14px;
            font-style: italic;
            color: #999;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .thinking-toggle {
            font-size: 12px;
            color: #999;
            opacity: 0.7;
        }

        .thinking-content {
            margin-top: 8px;
            margin-left: 20px;
            padding: 8px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 13px;
            color: #aaa;
        }

        .thinking-content.collapsed {
            display: none;
        }

        /* Â∑•ÂÖ∑‰ΩøÁî®Âùó - Êó∂Èó¥Á∫øÈ£éÊ†º */
        .tool-block {
            margin: 8px 0;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .tool-block:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .tool-main-line {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-icon {
            font-size: 16px;
            color: #64b5f6;
            flex-shrink: 0;
        }

        .tool-label {
            font-weight: 500;
            color: #eee;
            font-size: 14px;
        }

        .tool-file-link {
            color: #4caf50;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
            font-weight: 500;
        }

        .tool-file-link:hover {
            color: #66bb6a;
            text-decoration: underline;
        }

        .tool-params {
            margin-top: 6px;
            margin-left: 24px;
            font-size: 13px;
            color: #aaa;
        }

        .tool-param-line {
            margin: 2px 0;
        }

        .param-key {
            color: #999;
            font-size: 12px;
        }

        .param-value {
            color: #ccc;
            margin-left: 4px;
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #2a2a4e;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* ÈîôËØØÁä∂ÊÄÅ */
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* Âä®Áîª */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° - Â∞èÂ±èÂπï‰ºòÂåñ */
        @media (max-width: 768px) {
            #app {
                padding: 10px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .session-meta {
                font-size: 12px;
                gap: 10px;
            }

            .timeline {
                padding-left: 30px;
            }

            .timeline::before {
                left: 10px;
            }

            .timeline-item::before {
                left: -24px;
                width: 10px;
                height: 10px;
            }

            .message-card {
                padding: 12px;
            }

            .message-role {
                font-size: 14px;
            }
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f3460;
        }

        ::-webkit-scrollbar-thumb {
            background: #2a2a4e;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [session, setSession] = useState({
                sessionId: '',
                title: '',
                messageCount: 0,
                lastTimestamp: 0,
                messages: []
            });
            const [expandedThinking, setExpandedThinking] = useState({});

            useEffect(() => {
                loadSession();
            }, []);

            const loadSession = async () => {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const sessionId = urlParams.get('sessionId') || window.sessionId;
                    const projectPath = urlParams.get('projectPath') || window.projectPath;

                    if (!sessionId || !projectPath) {
                        throw new Error('Áº∫Â∞ë‰ºöËØùIDÊàñÈ°πÁõÆË∑ØÂæÑ');
                    }

                    if (window.sessionData) {
                        setSession(window.sessionData);
                        setLoading(false);
                        return;
                    }

                    const response = await fetch(`/api/session?sessionId=${sessionId}&projectPath=${encodeURIComponent(projectPath)}`);
                    const data = await response.json();

                    if (data.success) {
                        setSession(data.session);
                    } else {
                        throw new Error(data.error || 'Âä†ËΩΩÂ§±Ë¥•');
                    }
                } catch (e) {
                    setError(e.message);
                    console.error('Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•:', e);
                } finally {
                    setLoading(false);
                }
            };

            const getContentBlocks = (msg) => {
                if (!msg.message || !msg.message.content) {
                    return [];
                }

                const content = msg.message.content;

                if (typeof content === 'string') {
                    return [{ type: 'text', text: content }];
                }

                if (Array.isArray(content)) {
                    return content.map(block => {
                        if (block.type === 'text') {
                            return { type: 'text', text: block.text || '' };
                        } else if (block.type === 'thinking') {
                            return { type: 'thinking', text: block.thinking || '' };
                        } else if (block.type === 'tool_use') {
                            return {
                                type: 'tool_use',
                                toolName: block.name || 'Unknown',
                                toolInput: block.input || {}
                            };
                        }
                        return null;
                    }).filter(Boolean);
                }

                return [];
            };

            const getToolIcon = (toolName) => {
                const icons = {
                    'Read': 'üëÅÔ∏è',
                    'Edit': '‚úèÔ∏è',
                    'Write': 'üìù',
                    'Bash': '‚ö°',
                    'Grep': 'üîç',
                    'Glob': 'üìÅ',
                    'Task': 'üîß',
                    'WebFetch': 'üåê',
                    'WebSearch': 'üîé'
                };
                return icons[toolName] || 'üõ†Ô∏è';
            };

            const getToolDisplayName = (toolName) => {
                const toolNames = {
                    'Read': 'ËØªÂèñ',
                    'Edit': 'ÁºñËæë',
                    'Write': 'ÂÜôÂÖ•',
                    'Bash': 'ÊâßË°åÂëΩ‰ª§',
                    'Grep': 'ÊêúÁ¥¢',
                    'Glob': 'Êü•ÊâæÊñá‰ª∂',
                    'Task': 'ÊâßË°å‰ªªÂä°',
                    'WebFetch': 'Ëé∑ÂèñÁΩëÈ°µ',
                    'WebSearch': 'ÁΩëÁªúÊêúÁ¥¢'
                };
                return toolNames[toolName] || toolName;
            };

            const getFilePath = (toolInput) => {
                if (!toolInput) return null;
                return toolInput.file_path || toolInput.notebook_path || null;
            };

            const getFileName = (filePath) => {
                if (!filePath) return '';
                const parts = filePath.split('/');
                return parts[parts.length - 1];
            };

            const hasOtherParams = (toolInput) => {
                if (!toolInput) return false;
                const otherParams = getOtherParams(toolInput);
                return Object.keys(otherParams).length > 0;
            };

            const getOtherParams = (toolInput) => {
                if (!toolInput) return {};
                const params = { ...toolInput };
                delete params.file_path;
                delete params.notebook_path;
                return params;
            };

            const formatParamValue = (value) => {
                if (typeof value === 'object') {
                    return JSON.stringify(value, null, 2);
                }
                return String(value);
            };

            const openFile = (filePath) => {
                console.log('Opening file:', filePath);

                if (window.sendToJava) {
                    window.sendToJava('open_file:' + filePath);
                } else if (window.javaInterface && window.javaInterface.openFile) {
                    window.javaInterface.openFile(filePath);
                } else if (window.cefQuery) {
                    window.cefQuery({
                        request: JSON.stringify({
                            action: 'openFile',
                            filePath: filePath
                        }),
                        onSuccess: function(response) {
                            console.log('Êñá‰ª∂ÊâìÂºÄÊàêÂäü:', response);
                        },
                        onFailure: function(error_code, error_message) {
                            console.error('Êñá‰ª∂ÊâìÂºÄÂ§±Ë¥•:', error_message);
                        }
                    });
                } else {
                    console.log('Êñá‰ª∂Ë∑ØÂæÑ:', filePath);
                    alert('Êñá‰ª∂Ë∑ØÂæÑ: ' + filePath);
                }
            };

            const toggleThinking = (messageIndex, blockIndex) => {
                const key = `${messageIndex}_${blockIndex}`;
                setExpandedThinking(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            const isThinkingExpanded = (messageIndex, blockIndex) => {
                const key = `${messageIndex}_${blockIndex}`;
                return !!expandedThinking[key];
            };

            const formatDateTime = (timestamp) => {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const formatTime = (timestamp) => {
                if (!timestamp) return '';
                if (typeof timestamp === 'string') {
                    timestamp = new Date(timestamp).getTime();
                }
                const date = new Date(timestamp);
                return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
            };

            const goBack = () => {
                if (window.sendToJava) {
                    window.sendToJava('back_to_list');
                } else if (window.history.length > 1) {
                    window.history.back();
                } else {
                    window.location.href = 'claude-java-history.html';
                }
            };

            if (loading) {
                return (
                    <div className="loading">
                        <div className="spinner"></div>
                        <p>Âä†ËΩΩ‰∏≠...</p>
                    </div>
                );
            }

            if (error) {
                return <div className="error-message">{error}</div>;
            }

            return (
                <>
                    <div className="header">
                        <h1>üìù {session.title || '‰ºöËØùËØ¶ÊÉÖ'}</h1>
                        <div className="session-meta">
                            <span>üí¨ {session.messageCount} Êù°Ê∂àÊÅØ</span>
                            <span>üïê {formatDateTime(session.lastTimestamp)}</span>
                            <span>üÜî {session.sessionId}</span>
                        </div>
                        <button className="back-button" onClick={goBack}>‚Üê ËøîÂõû‰ºöËØùÂàóË°®</button>
                    </div>

                    {session.messages && session.messages.length > 0 ? (
                        <div className="timeline">
                            {session.messages.map((msg, index) => (
                                <div key={index} className={`timeline-item ${msg.type}`}>
                                    <div className="message-card">
                                        <div className="message-header">
                                            <div className="message-role">
                                                <span>{msg.type === 'user' ? 'üë§' : 'ü§ñ'}</span>
                                                <span>{msg.type === 'user' ? '‰Ω†' : 'Claude'}</span>
                                            </div>
                                            <div className="message-time">{formatTime(msg.timestamp)}</div>
                                        </div>
                                        <div className="message-body">
                                            {getContentBlocks(msg).map((block, blockIndex) => (
                                                <div key={blockIndex} className="content-block">
                                                    {block.type === 'text' && (
                                                        <div className="text-block">{block.text}</div>
                                                    )}

                                                    {block.type === 'thinking' && (
                                                        <div className="thinking-block">
                                                            <div className="thinking-header" onClick={() => toggleThinking(index, blockIndex)}>
                                                                <span className="thinking-title">üí≠ ÊÄùËÄÉÂÆåÊàê</span>
                                                                <span className="thinking-toggle">
                                                                    {isThinkingExpanded(index, blockIndex) ? '‚ñ≤' : '‚ñº'}
                                                                </span>
                                                            </div>
                                                            <div className={`thinking-content ${!isThinkingExpanded(index, blockIndex) ? 'collapsed' : ''}`}>
                                                                {block.text}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {block.type === 'tool_use' && (
                                                        <div className="tool-block">
                                                            <div className="tool-main-line">
                                                                <span className="tool-icon">{getToolIcon(block.toolName)}</span>
                                                                <span className="tool-label">{getToolDisplayName(block.toolName)}</span>
                                                                {getFilePath(block.toolInput) && (
                                                                    <a
                                                                        className="tool-file-link"
                                                                        onClick={(e) => { e.preventDefault(); openFile(getFilePath(block.toolInput)); }}
                                                                        title={getFilePath(block.toolInput)}
                                                                    >
                                                                        {getFileName(getFilePath(block.toolInput))}
                                                                    </a>
                                                                )}
                                                            </div>
                                                            {hasOtherParams(block.toolInput) && (
                                                                <div className="tool-params">
                                                                    {Object.entries(getOtherParams(block.toolInput)).map(([key, value]) => (
                                                                        <div key={key} className="tool-param-line">
                                                                            <span className="param-key">{key}:</span>
                                                                            <span className="param-value">{formatParamValue(value)}</span>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="empty-state">
                            <div className="empty-icon">üì≠</div>
                            <p>ÊöÇÊó†Ê∂àÊÅØ</p>
                        </div>
                    )}
                </>
            );
        }

        ReactDOM.render(<App />, document.getElementById('app'));
    </script>
</body>
</html>
